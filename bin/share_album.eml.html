module Types = Types
let render ~(album : Database.Db.album) ~(photos : Types.photo_variant list) : string =
<div>
  <div class="mb-6">
    <a href="/share" class="text-red-600 hover:text-red-700 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
      Back to Share
    </a>
  </div>
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-red-600">
      <%s album.Database.Db.name %>
    </h1>
  </div>
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="photo-grid">
  <%s! String.concat "" (List.mapi (fun idx (photo : Types.photo_variant) ->
    Printf.sprintf {|<div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer group" tabindex="0"
      aria-label="View photo" onclick="openGalleryModal(%d)">
      <img src="%s" alt="%s" class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
        loading="lazy">
    </div>|}
    idx
    photo.thumbnail_url
    photo.filename
    ) photos) %>
    </div>
<!-- Gallery Modal -->
<div id="gallery-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden">
  <div class="relative w-full max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
    <button onclick="closeGalleryModal()"
      class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold z-10">&times;</button>
    <div class="flex items-center justify-between px-2 py-4">
      <button id="prev-btn" onclick="galleryPrev()" class="p-2 text-gray-700 hover:text-red-600 disabled:opacity-50"
        aria-label="Previous photo">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <div class="flex-1 flex justify-center">
        <img id="gallery-img" src="" alt="" class="max-h-[60vh] object-contain rounded shadow" />
      </div>
      <button id="next-btn" onclick="galleryNext()" class="p-2 text-gray-700 hover:text-red-600 disabled:opacity-50"
        aria-label="Next photo">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      </div>
      <div class="flex flex-col items-center gap-2 px-4 pb-4">
        <div class="flex gap-4 w-full justify-center">
          <a id="download-btn" href="#" class="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700 text-sm"
            download>Download Original</a>
          <button id="share-btn" onclick="shareCurrentPhoto()"
            class="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 text-sm">Share</button>
        </div>
        <div id="gallery-filename" class="text-xs text-gray-500 truncate w-full text-center"></div>
      </div>
      </div>
      </div>
      
      <script id="photo-data" type="application/json">
      <%s! Yojson.Safe.to_string (`List (List.map (fun (p : Types.photo_variant) ->
        `Assoc [
          ("medium_url", `String p.medium_url);
          ("original_url", `String p.original_url);
          ("filename", `String p.filename)
        ]) photos)) %>
      </script>
      
      <script>
        const galleryPhotos = JSON.parse(document.getElementById('photo-data').textContent);
        let galleryIndex = 0;

        function openGalleryModal(idx) {
          galleryIndex = idx;
          updateGalleryModal();
          document.getElementById('gallery-modal').classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
        function closeGalleryModal() {
          document.getElementById('gallery-modal').classList.add('hidden');
          document.body.style.overflow = '';
        }
        function updateGalleryModal() {
          const photo = galleryPhotos[galleryIndex];
          document.getElementById('gallery-img').src = photo.medium_url;
          document.getElementById('gallery-img').alt = photo.filename;
          document.getElementById('download-btn').href = photo.original_url;
          document.getElementById('gallery-filename').textContent = photo.filename;
          document.getElementById('prev-btn').disabled = galleryIndex === 0;
          document.getElementById('next-btn').disabled = galleryIndex === galleryPhotos.length - 1;
        }
        function galleryPrev() {
          if (galleryIndex > 0) {
            galleryIndex--;
            updateGalleryModal();
          }
        }
        function galleryNext() {
          if (galleryIndex < galleryPhotos.length - 1) {
            galleryIndex++;
            updateGalleryModal();
          }
        }
        function shareCurrentPhoto() {
          const photo = galleryPhotos[galleryIndex];
          if (navigator.share) {
            navigator.share({
              title: photo.filename,
              url: photo.medium_url
            });
          } else {
            navigator.clipboard.writeText(photo.medium_url);
            alert('Photo link copied!');
          }
        }
        // Keyboard navigation and close on ESC
        window.addEventListener('keydown', function (e) {
          if (document.getElementById('gallery-modal').classList.contains('hidden')) return;
          if (e.key === 'ArrowLeft') galleryPrev();
          if (e.key === 'ArrowRight') galleryNext();
          if (e.key === 'Escape') closeGalleryModal();
        });
        // Close modal on background click
        window.addEventListener('click', function (e) {
          const modal = document.getElementById('gallery-modal');
          if (!modal.classList.contains('hidden') && e.target === modal) closeGalleryModal();
        });
      </script>
