module Types = Types let render ~(album : Database.Db.album) ~(photos :
Types.photo_variant list) : string =
<div>

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-red-600">
      <%s album.Database.Db.name %>
    </h1>
    <span id="photo-count" class="text-gray-500 text-base ml-2">
      <!-- JS will fill this -->
    </span>
  </div>
  <div
    class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
    id="photo-grid"
  >
    <!-- Images will be rendered by JS -->
  </div>
  <div class="flex justify-center mt-4">
    <button id="load-more" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold px-6 py-2 rounded shadow" style="display:none;">
      Load More
    </button>
  </div>
  <!-- Gallery Modal -->
  <div
    id="gallery-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden"
  >
    <div
      class="relative w-full max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden flex flex-col"
    >
      <button
        onclick="closeGalleryModal()"
        class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl font-bold z-10"
      >
        &times;
      </button>
      <div class="flex items-center justify-between px-2 py-4">
        <div class="flex-1 flex justify-center">
          <img
            id="gallery-img"
            src=""
            alt=""
            class="max-h-[60vh] object-contain rounded shadow"
          />
        </div>
      </div>
      <div class="flex justify-between items-center gap-2 px-4 pb-4">
        <button
          id="prev-btn"
          onclick="galleryPrev()"
          class="p-2 text-gray-700 hover:text-red-600 disabled:opacity-50"
          aria-label="Previous photo"
        >
          Previous
        </button>
        <div class="flex gap-4 w-full justify-center">
          <a
            id="download-btn"
            href="#"
            class="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700 text-sm"
            download
            >Download</a
          >
          <button
            id="share-btn"
            onclick="shareCurrentPhoto()"
            class="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 text-sm"
          >
            Share
          </button>
        </div>
        <button
          id="next-btn"
          onclick="galleryNext()"
          class="p-2 text-gray-700 hover:text-red-600 disabled:opacity-50"
          aria-label="Next photo"
        >
          Next
        </button>
      </div>
    </div>
  </div>

  <script>
    // Extract share token from URL
    function getShareToken() {
      const match = window.location.pathname.match(/\/share\/(.+)$/);
      return match ? match[1] : null;
    }
    const shareToken = getShareToken();
    const PAGE_SIZE = 20;
    let loadedPhotos = [];
    let totalPhotos = 0;
    let loading = false;
    let offset = 0;

    // Render images into the grid
    function renderPhotos() {
      const grid = document.getElementById('photo-grid');
      if (offset === PAGE_SIZE) {
  grid.innerHTML = '';
}
      loadedPhotos.forEach((photo, idx) => {
        const div = document.createElement('div');
        div.className = "aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer group";
        div.tabIndex = 0;
        div.setAttribute('aria-label', 'View photo');
        div.onclick = () => openGalleryModal(idx);
        div.innerHTML = `<img src="${photo.thumbnail_url}" alt="${photo.filename}" class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105" loading="lazy">`;
        grid.appendChild(div);
      });
      updatePhotoCount();
    }

    // Update the count display
    function updatePhotoCount() {
      document.getElementById('photo-count').textContent = `Showing ${loadedPhotos.length} photos`;
    }

    // Fetch next page of images from backend
    async function loadMorePhotos() {
      if (loading) return;
      loading = true;
      document.getElementById('load-more').disabled = true;
      try {
        const resp = await fetch(`/api/share_photos?token=${encodeURIComponent(shareToken)}&offset=${offset}&limit=${PAGE_SIZE}`);
        if (!resp.ok) throw new Error('Failed to fetch photos');
        const photos = await resp.json();
        if (Array.isArray(photos)) {
          loadedPhotos = loadedPhotos.concat(photos);
          offset += photos.length;
          renderPhotos();
          // If fewer than PAGE_SIZE returned, hide button (end reached)
          document.getElementById('load-more').style.display = (photos.length === PAGE_SIZE) ? '' : 'none';
        }
      } catch (e) {
        alert('Error loading photos');
      } finally {
        loading = false;
        document.getElementById('load-more').disabled = false;
      }
    }

    // Modal logic - works with loadedPhotos
    let galleryIndex = 0;
    function openGalleryModal(idx) {
      galleryIndex = idx;
      updateGalleryModal();
      document.getElementById('gallery-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeGalleryModal() {
      document.getElementById('gallery-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }
    function updateGalleryModal() {
      const photo = loadedPhotos[galleryIndex];
      document.getElementById('gallery-img').src = photo.medium_url;
      document.getElementById('gallery-img').alt = photo.filename;
      document.getElementById('download-btn').href = photo.original_url;
      document.getElementById('prev-btn').disabled = galleryIndex === 0;
      document.getElementById('next-btn').disabled = galleryIndex === loadedPhotos.length - 1;
    }
    function galleryPrev() {
      if (galleryIndex > 0) {
        galleryIndex--;
        updateGalleryModal();
      }
    }
    function galleryNext() {
      if (galleryIndex < loadedPhotos.length - 1) {
        galleryIndex++;
        updateGalleryModal();
      }
    }
    function shareCurrentPhoto() {
      const photo = loadedPhotos[galleryIndex];
      if (navigator.share) {
        navigator.share({
          title: photo.filename,
          url: photo.medium_url,
        });
      } else {
        navigator.clipboard.writeText(photo.medium_url);
        alert('Photo link copied!');
      }
    }
    // Keyboard navigation and close on ESC
    window.addEventListener('keydown', function (e) {
      if (document.getElementById('gallery-modal').classList.contains('hidden')) return;
      if (e.key === 'ArrowLeft') galleryPrev();
      if (e.key === 'ArrowRight') galleryNext();
      if (e.key === 'Escape') closeGalleryModal();
    });
    // Close modal on background click
    window.addEventListener('click', function (e) {
      const modal = document.getElementById('gallery-modal');
      if (!modal.classList.contains('hidden') && e.target === modal) closeGalleryModal();
    });

    // Init: load first page and set up Load More
    document.addEventListener('DOMContentLoaded', function () {
      loadedPhotos = [];
      offset = 0;
      loadMorePhotos();
      const loadMoreBtn = document.getElementById('load-more');
      loadMoreBtn.onclick = loadMorePhotos;
      loadMoreBtn.style.display = '';
    });
  </script>
</div>
